<!doctype HTML>
<html>
	<head>
		<title>Location Extractor</title>
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
		<style>
			.container {
				max-width: 970px;
			}
			.footer {
				padding-top: 10px;
				margin-top: 50px;
				border-top: 1px solid #ddd;
				font-size: 90%;
				color: #666;
			}
			.output {
				background-color: #eee;
				padding: 10px;
			}
			pre {
				border: none;
				color: #c7254e;
				background-color: #eee;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-sm-12">
					<div class="page-header">
						<h1>Location Extractor</h1>
					</div>
					<p class="lead">Enter a Tweet or text to extract location/address information from it.</p>
				</div>
			</div>

			<div class="row">
				<div class="col-sm-12 form-horizontal">
					<div class="form-group">
						<label class="sr-only">Enter text:</label>
						<div class="col-sm-8">
							<input type="text" maxlength="140" id="textField" value="" placeholder="e.g. Do you know any good eating places around Queen Street, Victoria London?" class="form-control">
						</div>
						<div class="col-sm-4">
							<button type="button" id="extractBtn" class="btn btn-default">Extract Location</button>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm-12">
					<h4>Original text:</h4>
						<div class="output" id="outputOriginalText"></div>

					<h4>Cleaned text:</h4>
						<div class="output" id="outputCleanedText"></div>

					<h4>Extracted Location:</h4>
						<div class="output" id="outputExtractedLocation"></div>
				</div>
			</div>

			<div class="row">
				<div class="footer col-sm-12">
					<ul class="list-inline clearfix">
						<li class="pull-left">&larr; <a href="https://github.com/jabranr/location-extractor">Back to Github</a></li>
						<li class="pull-right">&copy; Jabran Rafique</li>
					</ul>
				</div>
			</div>
		</div>

		<script src="//code.jquery.com/jquery.js"></script>
		<script src="//maps.googleapis.com/maps/api/js?v=3"></script>
		<script src="bower_components/location-extractor/dist/location-extractor.min.js"></script>
		<!-- <script src="bower_components/defiant.js/dist/defiant.min.js"></script> -->
		<script>
			$(document).ready(function() {
				var cities;
				var outputOriginalText = $('#outputOriginalText');
				var outputCleanedText = $('#outputCleanedText');
				var outputExtractedLocation = $('#outputExtractedLocation');
				var $textField = $('#textField').on('keydown keyup', function(e) {
					outputOriginalText.html( $(this).val() );
				});

				// Get a list of cities from JSON
				$.getJSON('./cities.json', function(data) {
					var refined = [];
					for (var key in data) {
						if ( data[key] !== '' ) {
							refined.push(data[key]);
						}
					}
					cities = [].concat.apply([], refined);
					cities = ''.toLowerCase.call(cities).split(',');
				});

				var $extractBtn = $('#extractBtn').on('click', function(e) {
					var $this = $(this);
					if ( $textField.val() == '' ) {
						$textField.focus();
						return;
					}

					if ( $textField.val() > 140 ) {
						alert('Text is over 140 characters.');
						$textField.select();
						return;
					}

					var extractor = new LocationExtractor($textField.val());
					extractor.clean();

					function findCity(needle) {
						for (var i = 0; i < cities.length; i++) {
							if ( cities[i] === needle ) {
								return cities[i];
							}
						}
					}


					outputCleanedText.html(extractor.data);

					if ( ! extractor.data ) {
						$textField.focus();
						return;
					}

					extractor.extract(function(data) {
						if ( data.error ) {
							var found = extractor.data.split(' ').filter(findCity);
							if ( found.length ) {
								extractor.data = found.join(' ');
								extractor.extract(function(data) {
									outputExtractedLocation.html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
								});
							}
							else {
								outputExtractedLocation.html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
							}
						}
						else {
							outputExtractedLocation.html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
						}
					});
				});
			});
		</script>

	</body>
</html>